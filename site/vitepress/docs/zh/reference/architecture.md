# 架构设计

本文档描述 vStats 的整体架构。

## 系统概览

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              用户                                         │
│                    (浏览器 / 移动端 / API 客户端)                          │
└─────────────────────────────────┬────────────────────────────────────────┘
                                  │ HTTPS / WSS
                                  ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                         反向代理（可选）                                   │
│                      (Nginx / Caddy / Traefik)                           │
└─────────────────────────────────┬────────────────────────────────────────┘
                                  │ HTTP / WS
                                  ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           vStats 服务端                                   │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                         Go 后端                                     │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │  │
│  │  │  HTTP 服务器 │  │   WebSocket  │  │      后台任务            │  │  │
│  │  │    (Gin)     │  │    处理器    │  │  (聚合、清理)            │  │  │
│  │  └──────┬───────┘  └──────┬───────┘  └────────────┬─────────────┘  │  │
│  │         │                 │                       │                 │  │
│  │         └─────────────────┴───────────────────────┘                 │  │
│  │                           │                                         │  │
│  │  ┌────────────────────────┴────────────────────────────────────┐   │  │
│  │  │                    数据层                                    │   │  │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐   │   │  │
│  │  │  │   SQLite DB  │  │   内存缓存   │  │    文件存储      │   │   │  │
│  │  │  │   (主存储)   │  │              │  │    (日志)        │   │   │  │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────┘   │   │  │
│  │  └─────────────────────────────────────────────────────────────┘   │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                     静态文件服务器                                   │  │
│  │                    (React SPA + 资源)                               │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                  │ WebSocket
                                  │
          ┌───────────────────────┼───────────────────────┐
          │                       │                       │
          ▼                       ▼                       ▼
   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
   │   Agent 1   │         │   Agent 2   │         │   Agent N   │
   │   (Linux)   │         │  (Windows)  │         │   (macOS)   │
   └─────────────┘         └─────────────┘         └─────────────┘
```

## 组件

### vStats 服务端

核心组件，负责：

1. **HTTP 服务器 (Gin)**
   - 提供 REST API 端点
   - 处理认证
   - 提供静态前端文件

2. **WebSocket 处理器**
   - 维护与 Agent 的连接
   - 向面板客户端广播更新
   - 处理实时通信

3. **后台任务**
   - 聚合历史数据指标
   - 清理旧数据
   - 监控 Agent 健康状态

4. **数据层**
   - SQLite 用于持久存储
   - 内存缓存用于实时数据
   - 文件系统用于日志

### vStats Agent

运行在被监控服务器上的轻量级守护进程：

1. **指标采集器**
   - CPU 统计来自 `/proc/stat`（Linux）或系统调用
   - 内存来自 `/proc/meminfo` 或系统 API
   - 磁盘来自文件系统统计
   - 网络来自 `/proc/net/dev` 或系统 API
   - GPU 来自 `nvidia-smi`（如可用）

2. **WebSocket 客户端**
   - 维护到服务端的持久连接
   - 按配置间隔发送指标
   - 自动处理重连

3. **配置管理器**
   - 从文件或环境读取配置
   - 支持运行时配置更新

### 前端 (React SPA)

使用以下技术构建的单页应用：

- **React 18** - UI 框架
- **TypeScript** - 类型安全
- **Tailwind CSS** - 样式
- **Framer Motion** - 动画
- **Recharts** - 数据可视化

## 数据流

### 指标采集

```
Agent                   服务端                  面板
  │                        │                        │
  │ 采集指标               │                        │
  │◄──────────────────────►│                        │
  │                        │                        │
  │ 通过 WebSocket 发送    │                        │
  │───────────────────────►│                        │
  │                        │                        │
  │                        │ 存入数据库             │
  │                        │◄──────────────────────►│
  │                        │                        │
  │                        │ 广播到客户端           │
  │                        │───────────────────────►│
  │                        │                        │
  │                        │                        │ 更新 UI
  │                        │                        │◄─────────
```

### 认证流程

```
用户                    服务端                  数据库
  │                        │                        │
  │ POST /api/auth/login   │                        │
  │───────────────────────►│                        │
  │                        │                        │
  │                        │ 验证凭据               │
  │                        │───────────────────────►│
  │                        │                        │
  │                        │◄───────────────────────│
  │                        │                        │
  │ 收到 JWT token         │                        │
  │◄───────────────────────│                        │
  │                        │                        │
  │ 后续请求               │                        │
  │ 带 Authorization       │                        │
  │───────────────────────►│                        │
  │                        │                        │
  │                        │ 验证 token             │
  │                        │ (本地，无需数据库)     │
  │                        │                        │
```

## 数据库结构

### 服务器表

```sql
CREATE TABLE servers (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  location TEXT,
  provider TEXT,
  token TEXT UNIQUE,
  online BOOLEAN DEFAULT FALSE,
  last_seen DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 指标表

```sql
CREATE TABLE metrics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  server_id TEXT NOT NULL,
  timestamp DATETIME NOT NULL,
  cpu_usage REAL,
  memory_usage REAL,
  disk_usage TEXT,  -- JSON
  network_rx INTEGER,
  network_tx INTEGER,
  FOREIGN KEY (server_id) REFERENCES servers(id)
);

CREATE INDEX idx_metrics_server_time ON metrics(server_id, timestamp);
```

## 技术选型

| 组件 | 技术 | 原因 |
|------|------|------|
| 后端语言 | Go | 性能好、单一二进制、并发性强 |
| HTTP 框架 | Gin | 快速、维护良好 |
| WebSocket | Gorilla | 健壮、功能完整 |
| 数据库 | SQLite | 简单、嵌入式、大多数部署足够 |
| 前端 | React | 组件化、生态丰富 |
| 样式 | Tailwind | 实用优先、开发快速 |
| 构建工具 | Vite | 构建快、工具现代 |

